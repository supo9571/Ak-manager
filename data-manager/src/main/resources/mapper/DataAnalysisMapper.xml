<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.data.mapper.DataAnalysisMapper">

   <select id="withdrawTopList" resultType="com.manager.common.core.domain.model.vo.DataAnalysisVO"  parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
       SELECT
           ceo.channel,
           ceo.uid,
           dr.name,
           dr.time,
           IFNULL(sum(ceo.withdraw_money),0) withdrawAmount
       from config_exchange_order ceo LEFT JOIN data_register dr on ceo.uid = dr.uid
       where
           exaa_status = 5
           <if test="beginTime!=null and beginTime !=''">
               and ceo.update_time between #{beginms} and #{endms}
           </if>
           <if test="tid!=null and tid!=''">
               and dr.channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
           </if>
           <if test="currentUserId!=null and currentUserId!=''">
               and dr.channel IN (
               SELECT t.t_id FROM sys_tenant t
               WHERE t.t_type = '2'
               AND (t.ancestors LIKE concat('%', #{currentUserId}, '%') OR t_id = #{currentUserId})
               )
           </if>
       GROUP BY channel,uid,dr.name
       ORDER BY sum(ceo.curr_money) desc LIMIT 100
   </select>

    <select id="getCurrentAmount" resultType="java.math.BigDecimal" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        SELECT curr_money from config_exchange_order
        where exaa_status = 5 and uid = #{uid}
        <if test="tid!=null and tid!=''">
            and channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
        </if>
        ORDER BY id desc LIMIT 1
    </select>

    <select id="rechargeAmount" resultType="java.math.BigDecimal" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        select IFNULL(sum(recharge_amount),0) amount  from config_recharge_order
        where payment_status = 1 and uid = #{uid}
        <if test="beginTime!=null and beginTime !=''">
            and update_time between #{beginms} and #{endms}
        </if>
        <if test="tid!=null and tid!=''">
            and channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
        </if>
    </select>

    <select id="rechargeAmountTotal" resultType="java.math.BigDecimal" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        select IFNULL(sum(recharge_amount),0) amount  from config_recharge_order
        where payment_status = 1 and uid = #{uid}
        <if test="tid!=null and tid!=''">
            and channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
        </if>
    </select>

    <select id="withdrawAmountTotal" resultType="java.math.BigDecimal" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        select IFNULL(sum(withdraw_money),0) amount  from config_exchange_order
        where exaa_status = 5 and uid = #{uid}
        <if test="tid!=null and tid!=''">
            and channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
        </if>
    </select>

    <select id="getDataWaterTopList" resultType="com.manager.common.core.domain.model.vo.DataWaterTopVO" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        SELECT
        dcu.channel,
        dcu.uid,
        dr.name,
        dr.time,
        IFNULL(sum(dcu.bet_coins),0) betTotal
        FROM
        data_card_user dcu
        LEFT JOIN data_register dr ON dcu.uid = dr.uid
        <where>
            <if test="beginTime!=null and beginTime !=''">
                and dcu.mstime between #{beginms} and #{endms}
            </if>
            <if test="tid!=null and tid!=''">
                and dr.channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
            </if>
            <if test="currentUserId!=null and currentUserId!=''">
                and dr.channel IN (
                SELECT t.t_id FROM sys_tenant t
                WHERE t.t_type = '2'
                AND (t.ancestors LIKE concat('%', #{currentUserId}, '%') OR t_id = #{currentUserId})
                )
            </if>
        </where>
        GROUP BY dcu.channel,dcu.uid,dr.NAME
        ORDER BY sum( dcu.bet_coins ) DESC
        LIMIT 100
    </select>

    <select id="getUserTableList" resultType="java.util.Map" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        SELECT uid, count(uid) count from data_card_user
        <where>
            <if test="beginTime!=null and beginTime !=''">
                and mstime between #{beginms} and #{endms}
            </if>
            <if test="tid!=null and tid!=''">
                and channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
            </if>
        </where>
        GROUP BY uid
    </select>

    <select id="getRechargeTopList" resultType="com.manager.common.core.domain.model.vo.RechargeTopVO" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        SELECT
            cro.channel,
            cro.uid,
            dr.name,
            dr.time,
            COUNT(cro.uid) rechargeCount,
            IFNULL(SUM(cro.recharge_amount),0) rechargeAmount,
            dr.login_time lastLoginTime
        FROM
        config_recharge_order cro
        LEFT JOIN data_register dr ON cro.uid = dr.uid
        <where>
            payment_status =1
            <if test="beginTime!=null and beginTime !=''">
                and dcu.mstime between #{beginms} and #{endms}
            </if>
            <if test="tid!=null and tid!=''">
                and dr.channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
            </if>
            <if test="currentUserId!=null and currentUserId!=''">
                and dr.channel IN (
                SELECT t.t_id FROM sys_tenant t
                WHERE t.t_type = '2'
                AND (t.ancestors LIKE concat('%', #{currentUserId}, '%') OR t_id = #{currentUserId})
                )
            </if>
        </where>
        GROUP BY cro.channel,cro.uid,dr.NAME
        ORDER BY sum(cro.recharge_amount) DESC
        LIMIT 100
    </select>

    <select id="getLastPayTime" resultType="com.manager.common.core.domain.model.vo.RechargeTopVO" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        SELECT after_order_money amount,recharge_type rechargeType,finish_time lastPayTime
        from config_recharge_order
        WHERE payment_status =1 and uid = #{uid}
        <if test="tid!=null and tid!=''">
            and channel IN (SELECT t_id FROM sys_tenant WHERE tenant = #{tid} AND t_type = '2')
        </if>
        <if test="currentUserId!=null and currentUserId!=''">
            and channel IN (
            SELECT t.t_id FROM sys_tenant t
            WHERE t.t_type = '2'
            AND (t.ancestors LIKE concat('%', #{currentUserId}, '%') OR t_id = #{currentUserId})
            )
        </if>
        ORDER BY finish_time desc
        LIMIT 1
    </select>

    <select id="getPlayGameList" resultType="com.manager.common.core.domain.model.vo.RechargeTopVO" parameterType="com.manager.common.core.domain.model.param.DataAnalysisParam">
        SELECT
            cg.game_name gameNames
        FROM
            data_card dc
            LEFT JOIN config_game cg ON dc.table_type = cg.game_id
        WHERE cg.game_name is not null and uid = #{uid}
        <if test="beginTime!=null and beginTime !=''">
            and dcu.mstime between #{beginms} and #{endms}
        </if>
        GROUP BY cg.game_name
        ORDER BY sum(dc.system_win) desc LIMIT 3
    </select>


</mapper>
